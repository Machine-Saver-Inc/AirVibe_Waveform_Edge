name: provision-edge

on:
  workflow_dispatch:
    inputs:
      label:
        description: "Linode label"
        required: false
        default: "ms-edge-01"
      region:
        description: "Linode region"
        required: false
        default: "us-east"
      type:
        description: "Linode type"
        required: false
        default: "g6-nanode-1"

permissions:
  contents: read
  id-token: write

jobs:
  provision:
    runs-on: ubuntu-latest

    # Map repo Secrets/Variables into Terraform env vars
    env:
      # Linode + instance
      TF_VAR_linode_token:  ${{ secrets.LINODE_TOKEN }}
      TF_VAR_label:         ${{ github.event.inputs.label }}
      TF_VAR_region:        ${{ github.event.inputs.region }}
      TF_VAR_type:          ${{ github.event.inputs.type }}
      TF_VAR_image:         linode/ubuntu24.04
      TF_VAR_ssh_pub_key:   ${{ secrets.SSH_PUB_KEY }}
      TF_VAR_root_pass:     ${{ secrets.ROOT_PASS }}

      # Project config
      TF_VAR_domain:        ${{ vars.DOMAIN }}
      TF_VAR_repo_url:      ${{ vars.REPO_URL }}
      TF_VAR_acme_email:    ${{ vars.ACME_EMAIL }}

      # Cloudflare (optional; used by provider + injected to cloud-init for LE DNS-01)
      CLOUDFLARE_API_TOKEN:        ${{ secrets.CF_API_TOKEN }}
      TF_VAR_cloudflare_api_token: ${{ secrets.CF_API_TOKEN }}

      # API admin + cert mode
      TF_VAR_admin_token:   ${{ vars.ADMIN_TOKEN }}
      TF_VAR_cert_mode:     ${{ vars.CERT_MODE }}

    steps:
      - name: Ensure defaults (safe fallbacks)
        shell: bash
        run: |
          # Default CERT_MODE if not set
          if [ -z "${TF_VAR_cert_mode}" ]; then
            echo "TF_VAR_cert_mode=private" >> "$GITHUB_ENV"
            echo "INFO: CERT_MODE unset; defaulting to 'private'." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Preflight checks
        shell: bash
        run: |
          if [ -z "${TF_VAR_admin_token}" ]; then
            echo "ERROR: ADMIN_TOKEN (repo variable) is required." >&2
            echo "Set it here: Settings → Secrets and variables → Actions → Variables." >&2
            exit 1
          fi
          if [ -z "${TF_VAR_domain}" ]; then
            echo "ERROR: DOMAIN (repo variable) is required." >&2
            exit 1
          fi
          if [ -z "${TF_VAR_repo_url}" ]; then
            echo "ERROR: REPO_URL (repo variable) is required (HTTPS URL of this Edge repo)." >&2
            exit 1
          fi
          if [ -z "${TF_VAR_linode_token}" ] || [ -z "${TF_VAR_ssh_pub_key}" ] || [ -z "${TF_VAR_root_pass}" ]; then
            echo "ERROR: LINODE_TOKEN, SSH_PUB_KEY, and ROOT_PASS must be set as repo Secrets." >&2
            exit 1
          fi
          echo "✅ Preflight passed."

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      - name: Capture outputs
        id: tfout
        working-directory: terraform
        run: terraform output -json > tfout.json

      - name: Wait for API health
        shell: bash
        run: |
          EDGE_DOMAIN=$(jq -r '.edge_domain.value' terraform/tfout.json)
          echo "Edge domain: ${EDGE_DOMAIN}" >> "$GITHUB_STEP_SUMMARY"
          echo "Waiting for API at https://${EDGE_DOMAIN}/healthz"
          for i in {1..30}; do
            if curl -sSf "https://${EDGE_DOMAIN}/healthz" >/dev/null; then
              echo "API is up at https://${EDGE_DOMAIN}/healthz" | tee -a "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
            sleep 10
          done
          echo "Timed out waiting for API at https://${EDGE_DOMAIN}/healthz" >&2
          exit 1
